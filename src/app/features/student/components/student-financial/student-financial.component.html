<div class="financial-container">
  <!-- Seção de Pagamentos Únicos -->
  <div class="section">
    <h2>Pagamentos de Cursos</h2>
    <div class="summary-card">
      <div class="summary-title">Resumo de Pagamentos Únicos</div>
      <div class="summary-content">
        <div>
          <div class="summary-value">{{ totalPaidUnique() | currency:'BRL' }}</div>
          <div class="summary-label">Total Pago</div>
        </div>
        <div>
          <div class="summary-value">{{ totalPendingUnique() | currency:'BRL' }}</div>
          <div class="summary-label">Total Pendente</div>
        </div>
      </div>
    </div>

    @for (payment of filteredPayments(); track payment.id) {
      <div class="payment-card" [class.refunded]="payment.paymentDetails.status === 'REFUNDED'"
        [attr.data-status]="payment.paymentDetails.status === 'REFUNDED' ? 'REEMBOLSADO' : ''">
        <div class="payment-header">
          <div class="course-info">
            <div class="course-image" *ngIf="getCourse(payment.courseId)?.image">
              <img [src]="getCourse(payment.courseId)?.image" [alt]="getCourse(payment.courseId)?.name">
            </div>
            <div class="course-details">
              <h3 class="course-title">{{ getCourse(payment.courseId)?.name }}</h3>
              <p class="course-description">{{ getCourse(payment.courseId)?.description }}</p>
            </div>
          </div>
          <div class="payment-value">
            {{ payment.paymentDetails.value | currency:'BRL' }}
            <span class="refunded-value" *ngIf="payment.paymentDetails.status === 'REFUNDED'">
              Reembolsado
            </span>
          </div>
        </div>

        <div class="payment-info">
          <div class="payment-date">
            <i class="fas fa-calendar"></i>
            {{ payment.paymentDetails.dueDate | date:'dd/MM/yyyy' }}
            <span class="refund-date" *ngIf="payment.paymentDetails.refundedDate">
              Reembolsado em {{ payment.paymentDetails.refundedDate | date:'dd/MM/yyyy' }}
            </span>
          </div>
          <div class="status-badge" [ngClass]="payment.paymentDetails.status.toLowerCase()">
            <i class="fas" [ngClass]="{
              'fa-clock': payment.paymentDetails.status === 'PENDING',
              'fa-check': payment.paymentDetails.status === 'CONFIRMED' || payment.paymentDetails.status === 'RECEIVED',
              'fa-undo': payment.paymentDetails.status === 'REFUNDED',
              'fa-exclamation-circle': payment.paymentDetails.status === 'OVERDUE'
            }"></i>
            {{ payment.paymentDetails.status }}
          </div>
        </div>

        <!-- Botões de Pagamento para status PENDING -->
        <div class="payment-methods" *ngIf="payment.paymentDetails.status === 'PENDING'">
          <button class="payment-button credit-card" (click)="processPayment(payment, 'CREDIT_CARD')">
            <div class="button-content">
              <i class="fas fa-credit-card"></i>
              <span>Cartão de Crédito</span>
              <small>Pague em até {{getCourse(payment.courseId)?.portionCount}}x sem juros</small>
            </div>
          </button>

          <!-- Link para PIX quando disponível -->
          <ng-container *ngIf="payment.paymentDetails.invoiceUrl">
            <button class="payment-button pix" (click)="openPaymentUrl(payment.paymentDetails.invoiceUrl)">
              <div class="button-content">
                <i class="fas fa-qrcode"></i>
                <span>Pagar com PIX</span>
                <small>Aprovação instantânea</small>
              </div>
            </button>
          </ng-container>

          <!-- Botão para gerar novo PIX -->
          <ng-container *ngIf="!payment.paymentDetails.invoiceUrl">
            <button class="payment-button pix" (click)="processPayment(payment, 'PIX')">
              <div class="button-content">
                <i class="fas fa-qrcode"></i>
                <span>Pagar com PIX</span>
                <small>Aprovação instantânea</small>
              </div>
            </button>
          </ng-container>

          <!-- Link para boleto quando disponível -->
          <ng-container *ngIf="payment.paymentDetails.bankSlipUrl">
            <a [href]="payment.paymentDetails.bankSlipUrl" 
               target="_blank" 
               class="payment-button boleto">
              <div class="button-content">
                <i class="fas fa-barcode"></i>
                <span>Visualizar Boleto</span>
                <small>Vencimento em 3 dias</small>
              </div>
            </a>
          </ng-container>

          <!-- Botão para gerar novo boleto -->
          <ng-container *ngIf="!payment.paymentDetails.bankSlipUrl">
            <button class="payment-button boleto" (click)="processPayment(payment, 'BOLETO')">
              <div class="button-content">
                <i class="fas fa-barcode"></i>
                <span>Pagar com Boleto</span>
                <small>Vencimento em 3 dias</small>
              </div>
            </button>
          </ng-container>
        </div>

        <!-- Botão para copiar código PIX quando disponível -->
        <div class="payment-actions" *ngIf="payment.paymentDetails.pixCopiaECola">
          <button class="btn btn-outline" (click)="copyPixCode(payment.paymentDetails.pixCopiaECola)">
            <i class="fas fa-copy"></i>
            Copiar Código PIX
          </button>
        </div>
      </div>
    }
  </div>

  <!-- Seção de Assinaturas -->
  <div class="section">
    <h2>Assinaturas</h2>
    <div class="summary-card">
      <div class="summary-title">Resumo de Assinaturas</div>
      <div class="summary-content">
        <div>
          <div class="summary-value">{{ totalPaidSubscription() | currency:'BRL' }}</div>
          <div class="summary-label">Total Pago</div>
        </div>
        <div>
          <div class="summary-value">{{ totalPendingSubscription() | currency:'BRL' }}</div>
          <div class="summary-label">Total Pendente</div>
        </div>
      </div>
    </div>

    
    <div class="payment-card" 
         *ngFor="let payment of subscriptionPayments()"
         [ngClass]="{'inactive': subscription()?.status === 'CANCELLED'}"
         [attr.data-status]="subscription()?.status === 'CANCELLED' ? 'Inativa' : ''">
      <div class="payment-header">
        <div class="course-info">
          <ng-container *ngIf="getCourse(payment.courseId) as course">
            <div class="course-image">
              <img [src]="course.image" [alt]="course.name">
            </div>
            <div class="course-details">
              <div class="course-title">{{ course.name }}</div>
              <div class="course-description">{{ course.description }}</div>
            </div>
          </ng-container>
          <div class="payment-type">
            <span>Assinatura mensal</span>
            <div class="subscription-status" [ngClass]="subscription()?.status!.toLowerCase()">
              <i class="fas" [ngClass]="{
                'fa-check-circle': subscription()?.status === 'ACTIVE',
                'fa-times-circle': subscription()?.status === 'CANCELLED'
              }"></i>
              {{ subscription()?.status === 'ACTIVE' ? 'Ativa' : 'Inativa' }}
            </div>
            <ng-container *ngIf="subscription()?.status === 'ACTIVE'">
              <span class="next-payment">
                <i class="fas fa-calendar-alt"></i>
                Próximo pagamento: {{ subscription()?.nextDueDate | date:'dd/MM/yyyy' }}
              </span>
            </ng-container>
          </div>
        </div>
        <div class="payment-value">{{ payment.paymentDetails.value | currency:'BRL' }}</div>
      </div>
      
      <div class="payment-info">
        <div class="payment-date">
          <i class="fas fa-calendar"></i>
          <span>{{ payment.paymentDetails.dueDate | date:'dd/MM/yyyy' }}</span>
        </div>
        <span class="status-badge" [ngClass]="payment.paymentDetails.status.toLowerCase()">
          <i class="fas" [ngClass]="{
            'fa-clock': payment.paymentDetails.status === 'PENDING',
            'fa-check-circle': payment.paymentDetails.status === 'CONFIRMED' || payment.paymentDetails.status === 'RECEIVED',
            'fa-exclamation-circle': payment.paymentDetails.status === 'OVERDUE'
          }"></i>
          {{ payment.paymentDetails.status }}
        </span>
      </div>

      <div class="payment-actions">
        <ng-container *ngIf="payment.paymentDetails.status === 'PENDING'">
          <a *ngIf="payment.paymentDetails.bankSlipUrl" 
             [href]="payment.paymentDetails.bankSlipUrl" 
             target="_blank" 
             class="btn btn-primary">
            <i class="fas fa-file-invoice"></i>
            Visualizar Boleto
          </a>
          <button *ngIf="payment.paymentDetails.pixCopiaECola" 
                  class="btn btn-outline"
                  (click)="copyPixCode(payment.paymentDetails.pixCopiaECola)">
            <i class="fas fa-qrcode"></i>
            Copiar Código PIX
          </button>
        </ng-container>
        
        <button *ngIf="subscription()?.status === 'ACTIVE'"
                class="btn btn-danger"
                (click)="cancelSubscription(subscription()?.id || '')">
          <i class="fas fa-times-circle"></i>
          Cancelar Assinatura
        </button>
      </div>
    </div>
  </div>
</div>

