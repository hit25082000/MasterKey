<div class="history-container">
  <mat-tab-group animationDuration="500ms" class="custom-tabs">
    <!-- Aba de Pagamentos -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">receipt</mat-icon>
        <span>Pagamentos</span>
      </ng-template>
      
      <div class="payments-container">
        <mat-card *ngFor="let payment of payments$ | async" class="payment-card animate-in">
          <mat-card-header>
            <mat-icon mat-card-avatar [class]="'payment-icon ' + payment.paymentMethod.toLowerCase()">
              {{ 
                payment.paymentMethod === 'PIX' ? 'qr_code_2' :
                payment.paymentMethod === 'CREDIT_CARD' ? 'credit_card' : 'receipt_long'
              }}
            </mat-icon>
            <mat-card-title>{{ payment.paymentDetails.description || 'Pagamento #' + payment.paymentId }}</mat-card-title>
            <mat-card-subtitle>
              {{ payment.createdAt | date:'dd/MM/yyyy HH:mm' }}
            </mat-card-subtitle>
          </mat-card-header>
          
          <mat-card-content>
            <div class="payment-info">
              <div class="info-row">
                <span class="label">Valor:</span>
                <span class="value">R$ {{ payment.amount | number:'1.2-2' }}</span>
              </div>
              <div class="info-row">
                <span class="label">Método:</span>
                <span class="value method">{{ getPaymentMethodTranslation(payment.paymentMethod) }}</span>
              </div>
              <div class="info-row">
                <span class="label">Status:</span>
                <mat-chip-set>
                  <mat-chip [class]="'status-chip ' + payment.status.toLowerCase()" 
                           [color]="getStatusColor(payment.status)" 
                           selected>
                    {{ getPaymentStatusTranslation(payment.status) }}
                  </mat-chip>
                </mat-chip-set>
              </div>
            </div>

            <mat-expansion-panel class="custom-expansion">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon>info</mat-icon>
                  Detalhes do Pagamento
                </mat-panel-title>
              </mat-expansion-panel-header>
              
              <div class="payment-details">
                <div *ngIf="payment.paymentDetails.bankSlipUrl" class="detail-item">
                  <mat-icon>description</mat-icon>
                  <a [href]="payment.paymentDetails.bankSlipUrl" target="_blank" mat-button color="primary">
                    Ver Boleto
                  </a>
                </div>

                <div *ngIf="payment.paymentDetails.pixQrCodeUrl" class="detail-item pix-details">
                  <div class="qr-container">
                    <img [src]="payment.paymentDetails.pixQrCodeUrl" alt="QR Code PIX">
                  </div>
                  <div class="pix-code">
                    <p>Código PIX:</p>
                    <pre>{{ payment.paymentDetails.pixCopiaECola }}</pre>
                    <button mat-button color="primary" (click)="copyToClipboard(payment.paymentDetails.pixCopiaECola)">
                      <mat-icon>content_copy</mat-icon> Copiar código
                    </button>
                  </div>
                </div>

                <div *ngIf="payment.paymentDetails.invoiceUrl" class="detail-item">
                  <mat-icon>receipt</mat-icon>
                  <a [href]="payment.paymentDetails.invoiceUrl" target="_blank" mat-button color="primary">
                    Ver Fatura
                  </a>
                </div>
              </div>
            </mat-expansion-panel>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>

    <!-- Aba de Assinaturas -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">subscriptions</mat-icon>
        <span>Assinaturas</span>
      </ng-template>
      
      <div class="subscriptions-container">
        <mat-card *ngFor="let subscription of subscriptions$ | async" class="subscription-card animate-in">
          <mat-card-header>
            <mat-icon mat-card-avatar class="subscription-icon">
              {{ subscription.status === 'ACTIVE' ? 'auto_renew' : 'schedule' }}
            </mat-icon>
            <mat-card-title>{{ subscription.courseName }}</mat-card-title>
            <mat-card-subtitle>
              Assinatura #{{ subscription.id }}
            </mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <!-- Informações da Assinatura -->
            <div class="subscription-info">
              <p>{{ getSubscriptionStatusTranslation(subscription.status) }}</p>
              <p>{{ getSubscriptionCycleTranslation(subscription.cycle) }}</p>
              <p>{{ subscription.value * subscription.maxInstallments | currency:'BRL' }}</p>
              <p>{{ subscription.nextDueDate | date:'dd/MM/yyyy' }}</p>
            </div>

            <!-- Histórico de Pagamentos -->
            <mat-expansion-panel class="history-panel" *ngIf="subscription.subscriptionDetails?.paymentHistory?.length">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon>history</mat-icon>
                  <span>Histórico de Pagamentos</span>
                  <span class="payment-count">{{ subscription.subscriptionDetails?.paymentHistory?.length }} pagamentos</span>
                </mat-panel-title>
              </mat-expansion-panel-header>

              <div class="payment-cards">
                <div *ngFor="let payment of subscription.subscriptionDetails?.paymentHistory" class="payment-card-item">
                  <div class="payment-header">
                    <span class="installment-number">{{ payment.installmentNumber }}ª Parcela</span>
                    <span class="payment-value">{{ payment.value | currency:'BRL' }}</span>
                  </div>
                  <div class="payment-details">
                    <div class="payment-date">
                      <mat-icon>event</mat-icon>
                      {{ payment.dueDate | date:'dd/MM/yyyy' }}
                    </div>
                    <div class="payment-status" [ngClass]="payment.status.toLowerCase()">
                      <mat-icon>{{ 
                        payment.status === 'CONFIRMED' ? 'check_circle' :
                        payment.status === 'PENDING' ? 'schedule' :
                        payment.status === 'OVERDUE' ? 'error' : 'info'
                      }}</mat-icon>
                      {{ getPaymentStatusTranslation(payment.status) }}
                    </div>
                  </div>
                  <div class="payment-actions" *ngIf="payment.status !== 'CONFIRMED'">
                    <button mat-button (click)="gerarPagamentoFatura(subscription, 'PIX', payment.dueDate)">
                      <mat-icon>qr_code_2</mat-icon> PIX
                    </button>
                    <button mat-button (click)="gerarPagamentoFatura(subscription, 'BOLETO', payment.dueDate)">
                      <mat-icon>receipt</mat-icon> Boleto
                    </button>
                    <button mat-button (click)="gerarPagamentoFatura(subscription, 'CREDIT_CARD', payment.dueDate)">
                      <mat-icon>credit_card</mat-icon> Cartão
                    </button>
                  </div>
                </div>
              </div>
            </mat-expansion-panel>

            <!-- Próximos Pagamentos -->
            <mat-expansion-panel class="next-payments-panel" *ngIf="subscription.subscriptionDetails?.nextPayments?.length">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon>upcoming</mat-icon>
                  <span>Próximos Pagamentos</span>
                  <span class="payment-count">{{ subscription.subscriptionDetails?.nextPayments?.length }} pagamentos</span>
                </mat-panel-title>
              </mat-expansion-panel-header>

              <div class="payment-cards">
                <div *ngFor="let payment of subscription.subscriptionDetails?.nextPayments" class="payment-card-item">
                  <div class="payment-header">
                    <span class="installment-number">{{ payment.installmentNumber }}ª Parcela</span>
                    <span class="payment-value">{{ subscription.value | currency:'BRL' }}</span>
                  </div>
                  <div class="payment-details">
                    <div class="payment-date">
                      <mat-icon>event</mat-icon>
                      {{ payment.dueDate | date:'dd/MM/yyyy' }}
                    </div>
                    <div class="payment-status pending">
                      <mat-icon>schedule</mat-icon>
                      Pendente
                    </div>
                  </div>
                  <div class="payment-actions">
                    <button mat-button (click)="gerarPagamentoFatura(subscription, 'PIX', payment.dueDate)">
                      <mat-icon>qr_code_2</mat-icon> PIX
                    </button>
                    <button mat-button (click)="gerarPagamentoFatura(subscription, 'BOLETO', payment.dueDate)">
                      <mat-icon>receipt</mat-icon> Boleto
                    </button>
                    <button mat-button (click)="gerarPagamentoFatura(subscription, 'CREDIT_CARD', payment.dueDate)">
                      <mat-icon>credit_card</mat-icon> Cartão
                    </button>
                  </div>
                </div>
              </div>
            </mat-expansion-panel>

            <!-- Progresso da Assinatura -->
            <div class="subscription-progress">
              <p>
                Parcelas pagas: {{ getInstallmentInfo(subscription).current }} 
                de {{ getInstallmentInfo(subscription).total }}
              </p>
              <mat-progress-bar
                mode="determinate"
                [value]="calculateProgress(subscription)">
              </mat-progress-bar>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>

<!-- Template para lista de pagamentos -->
<ng-template #paymentsList let-payments>
  <div class="payments-list">
    <div *ngFor="let payment of payments" class="payment-history-item">
      <div class="payment-history-info">
        <div class="date">
          <mat-icon>event</mat-icon>
          {{ payment.createdAt | date:'dd/MM/yyyy' }}
        </div>
        <div class="amount">
          <mat-icon>attach_money</mat-icon>
          R$ {{ payment.amount | number:'1.2-2' }}
        </div>
        <mat-chip-set>
          <mat-chip [class]="'status-chip ' + payment.status.toLowerCase()" 
                   [color]="getStatusColor(payment.status)" 
                   selected>
            {{ payment.status }}
          </mat-chip>
        </mat-chip-set>
      </div>
    </div>
  </div>
</ng-template>